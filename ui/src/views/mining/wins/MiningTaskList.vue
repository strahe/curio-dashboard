<script setup lang="ts">
import { computed, ComputedRef, ref } from 'vue'
import { MiningTask } from '@/typed-graph'
import { GetMiningWins } from '@/gql/mining'
import { useQuery } from '@vue/apollo-composable'
import { useTableSettingsStore } from "@/stores/table"
import { getRelativeTime } from '@/utils/helpers/time'

const props = defineProps({
  start: {
    type: Date,
    default: undefined
  },
  end: {
    type: Date,
    default: undefined
  },
  miner: {
    type: String,
    default: undefined
  },
  include: {
    type: Boolean,
    default: true,
  },
})

const tableSettings = useTableSettingsStore()

const page = ref(1)
const limit = ref(100)
const offset = computed(() => (page.value - 1) * limit.value)
const start = ref<Date | undefined>(props.start)
const end = ref<Date | undefined>(props.end)
const selectMiner = ref(props.miner)
const include = ref(props.include)

const selectDateRange = computed({
  get: () => [start.value, end.value].filter(Boolean),
  set: value => {
    if (value) {
      if (value.length === 1) {
        if (value[0]) {
          start.value = value[0]
          end.value = new Date(start.value.getTime() + 24 * 60 * 60 * 1000) // +1 day
        }
      } else {
        start.value = value[0]
        end.value = value[value.length - 1]
      }
    }
  },
})

const { result, loading } = useQuery(GetMiningWins, {
  miner: selectMiner,
  start,
  end,
  include,
  offset,
  limit,
}, () => ({
  fetchPolicy: 'cache-first',
}))

const items: ComputedRef<[MiningTask]> = computed(() => result.value?.miningWins || [])
const itemsCount = computed<number>((): number => {
  return result.value?.miningWinsCount || itemsCount.value || 0
})

const headers = [
  { title: 'ID', key: 'taskId', sortable: false },
  { title: 'Miner', key: 'spId', sortable: false },
  { title: 'Epoch', key: 'epoch', sortable: false },
  { title: 'MinedCid', key: 'minedCid', sortable: false },
  { title: 'MinedAt', key: 'minedAt', sortable: false },
  { title: 'SubmittedAt', key: 'submittedAt', sortable: false },
  { title: 'Included', key: 'included', sortable: false, align: 'center' },
  { title: 'MinedHeader', key: 'minedHeader', sortable: false, align: 'center' },
] as const

</script>

<template>
  <v-card
    class="bg-surface"
    elevation="0"
    variant="outlined"
  >
    <v-card-item>
      <div class="action-box c-input-container">
        <MinerSelectInput 
          v-model="selectMiner" 
          class="c-input miner-select"
        />
        <DateRangeSelectInput
          v-model="selectDateRange"
          class="c-input date-range-select"
          label="Date Range"
        />
        <v-switch
          v-model="include"
          color="primary"
          :disabled="loading"
          label="Valid"
        />
      </div>
    </v-card-item>
    <v-divider />
    <v-card-text class="pa-0">
      <v-data-table-server
        v-model:items-per-page="tableSettings.itemsPerPage"
        v-model:page="page"
        :fixed-header="tableSettings.fixedHeader"
        :headers="headers"
        height="calc(100vh - 300px)"
        :hover="tableSettings.hover"
        :items="items"
        :items-length="itemsCount"
        :loading="loading"
        :items-per-page-options="tableSettings.itemsPerPageOptions"
      >
        <template #item.spId="{ value }">
          <RouterLink :to="{ name: 'MinerDetails', params: { id: value } }">
            {{ value }}
          </RouterLink>
        </template>
        <template #item.epoch="{ value }">
          <EpochField :epoch="value" />
        </template>
        <template #item.minedCid="{ value }">
          <TruncatedText :text="value" />
        </template>
        <template #item.minedAt="{value}">
          {{ getRelativeTime(value, 'long') }}
        </template>
        <template #item.submittedAt="{value}">
          {{ getRelativeTime(value, 'long') }}
        </template>
        <template #item.included="{value}">
          <StatusIcon
            :status="value ? 'success': 'failure'"
            :tooltip="value ? 'Yes': 'No'"
          />
        </template>
        <template #item.minedHeader="{value}">
          <InfoDialog>
            <JsonViewer
              :data="value"
              title="Mined Header"
            />
          </InfoDialog>
        </template>
      </v-data-table-server>
    </v-card-text>
  </v-card>
</template>

<style scoped lang="scss">
.action-box {
  display: flex;
  align-items: center;
  gap: 10px;
  
  .miner-select{
    width: 200px;
    max-width: 200px;
    :deep(.v-input) {
      width: 200px;
    }
    :deep(.v-input__control) {
      width: 200px;
    }
  }
  .date-range-select {
    min-width: 180px;
    :deep(.v-input) {
      width: 180px;
    }
    :deep(.v-input__control) {
      min-width: 180px;
    }
  }
  .c-input {  
    flex: 1;
  }
}
</style>
